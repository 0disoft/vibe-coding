name: CI

on:
  pull_request:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      run_a11y:
        description: Run Design System Lab a11y smoke test (A11Y=1)
        type: boolean
        default: false
      run_visual:
        description: Run Design System Lab visual regression test (VISUAL=1)
        type: boolean
        default: false
      update_visual_snapshots:
        description: Update visual snapshots (only when run_visual is true)
        type: boolean
        default: false

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version-file: .bun-version

      - name: Install
        run: bun install --frozen-lockfile

      - name: Generate Paraglide Runtime
        run: bunx paraglide-js compile --project ./project.inlang --outdir ./src/lib/paraglide --strategy url cookie preferredLanguage baseLocale --silent

      - name: Lint
        run: bun run lint

      - name: Typecheck (App)
        run: bun run check

      - name: Typecheck (Scripts)
        run: bun run check:scripts

      - name: Install Playwright (Chromium) for Vitest Browser
        run: bunx playwright install --with-deps chromium

      - name: Unit Tests
        run: bun run test:unit -- --run

      - name: Verify DTCG → CSS Tokens
        run: bun .vibe-coding/TOOLS/design-system/dtcg-sync.ts --verify

      - name: Verify DTCG → CSS Tokens (Root)
        run: bun .vibe-coding/TOOLS/design-system/dtcg-sync.ts --preset root --verify

      - name: Verify Design Tokens Manifest
        run: bun .vibe-coding/TOOLS/design-system/tokens-manifest.ts --stable --verify

  e2e_a11y:
    if: ${{ github.event_name == 'workflow_dispatch' && inputs.run_a11y }}
    runs-on: ubuntu-latest
    needs: test
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version-file: .bun-version

      - name: Install
        run: bun install --frozen-lockfile

      - name: Install Playwright (Chromium)
        run: bunx playwright install --with-deps chromium

      - name: Design System Lab A11y Smoke (Desktop)
        env:
          A11Y: "1"
        run: bun run test:e2e -- e2e/design-system-lab.a11y.spec.ts --project=Desktop

  e2e_visual:
    if: ${{ github.event_name == 'workflow_dispatch' && inputs.run_visual }}
    runs-on: windows-latest
    needs: test
    defaults:
      run:
        shell: bash
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version-file: .bun-version

      - name: Install
        run: bun install --frozen-lockfile

      - name: Install Playwright (Chromium)
        run: bunx playwright install chromium

      - name: Design System Lab Visual Regression (Desktop)
        env:
          VISUAL: "1"
        run: |
          if [ "${{ inputs.update_visual_snapshots }}" = "true" ]; then
            bun run test:e2e -- e2e/design-system-lab.visual.spec.ts --project=Desktop --update-snapshots
          else
            bun run test:e2e -- e2e/design-system-lab.visual.spec.ts --project=Desktop
          fi
