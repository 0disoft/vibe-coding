# Request ID & Error Handling (Security Update)

## 1. 서버 훅 (Server Hooks) - [최신]
**파일**: `src/hooks.server.ts`

### handleRequestId (외부 헤더 연동)
외부 시스템(로드밸런서/프록시)의 Trace ID를 유지하여 분산 트레이싱을 지원합니다.

```typescript
const handleRequestId: Handle = async ({ event, resolve }) => {
  // [개선] 외부 헤더 우선 사용 (없을 때만 UUID 생성)
  const requestId = event.request.headers.get('x-request-id') || crypto.randomUUID();
  event.locals.requestId = requestId;
  
  const response = await resolve(event);
  response.headers.set('x-request-id', requestId);
  return response;
};
```

### handleError (보안 마스킹 적용)
내부 정보(SQL, 경로 등) 유출 방지를 위해 클라이언트 응답 메시지를 마스킹합니다.

```typescript
export const handleError: HandleServerError = ({ error, event }) => {
  const requestId = event.locals.requestId || 'unknown';
  
  // [보안] 클라이언트에게는 항상 일반적인 메시지만 전달
  const message = 'Internal Server Error'; 

  // [로깅] 서버 콘솔에는 원본 에러와 Request ID 함께 기록
  console.error(`[${requestId}] Server Error:`, error);

  return {
    message, // 마스킹된 메시지 전달
    requestId
  };
};
```

## 2. 타입 정의 (Type Definitions)
**파일**: `src/app.d.ts` (이전 작업과 동일)
* `App.Locals.requestId`: 서버 내부 요청 추적용
* `App.Error.requestId`: 에러 페이지 전달용
