<!DOCTYPE html>
<html lang="ko">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Webnovel Viewer</title>
  <style>
    :root {
      --bg-primary: #0f0f23;
      --bg-secondary: #1a1a2e;
      --bg-card: #16213e;
      --text-primary: #e8e8e8;
      --text-secondary: #a0a0a0;
      --accent: #ff6b9d;
      --accent-hover: #ff4785;
      --success: #00e676;
      --warning: #ffab00;
      --border: #2d2d44;
      --shadow: rgba(0, 0, 0, 0.3);
      --radius: 12px;
      --glass: rgba(255, 255, 255, 0.05);
      --character: #ff6b9d;
      --object: #00d9ff;
      --phenomenon: #a855f7;
      --hook: #ffab00;
      --loop: #00e676;
    }

    [data-theme="light"] {
      --bg-primary: #f8f9fa;
      --bg-secondary: #ffffff;
      --bg-card: #ffffff;
      --text-primary: #1a1a2e;
      --text-secondary: #666666;
      --accent: #d63384;
      --accent-hover: #b02a6f;
      --border: #e0e0e0;
      --shadow: rgba(0, 0, 0, 0.1);
      --glass: rgba(0, 0, 0, 0.02);
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :focus-visible {
      outline: 2px solid var(--accent);
      outline-offset: 2px;
    }

    .sr-only {
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0, 0, 0, 0);
      white-space: nowrap;
      border: 0;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--bg-primary);
      color: var(--text-primary);
      min-height: 100vh;
      line-height: 1.6;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 2rem;
    }

    /* í—¤ë” */
    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 2rem;
      padding-bottom: 1rem;
      border-bottom: 1px solid var(--border);
    }

    h1 {
      font-size: 1.75rem;
      background: linear-gradient(135deg, var(--character), var(--phenomenon));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .header-actions {
      display: flex;
      gap: 1rem;
      align-items: center;
    }

    .theme-toggle {
      background: var(--glass);
      border: 1px solid var(--border);
      border-radius: 50%;
      width: 40px;
      height: 40px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.25rem;
      transition: all 0.2s;
    }

    .theme-toggle:hover {
      background: var(--accent);
      border-color: var(--accent);
    }

    /* í†µê³„ ì¹´ë“œ */
    .stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 1rem;
      margin-bottom: 2rem;
    }

    .stat-card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 1.25rem;
      text-align: center;
      transition: transform 0.2s, box-shadow 0.2s;
    }

    .stat-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 24px var(--shadow);
    }

    .stat-value {
      font-size: 2rem;
      font-weight: 700;
      color: var(--accent);
    }

    .stat-label {
      font-size: 0.875rem;
      color: var(--text-secondary);
      margin-top: 0.25rem;
    }

    /* í•„í„° ì„¹ì…˜ */
    .filters {
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 1.5rem;
      margin-bottom: 2rem;
    }

    .filters-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
    }

    .filters-title {
      font-size: 1rem;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .filter-count {
      background: var(--accent);
      color: var(--bg-primary);
      font-size: 0.75rem;
      padding: 0.125rem 0.5rem;
      border-radius: 999px;
      font-weight: 600;
    }

    .clear-filters {
      background: none;
      border: none;
      color: var(--text-secondary);
      cursor: pointer;
      font-size: 0.875rem;
      text-decoration: underline;
    }

    .clear-filters:hover {
      color: var(--accent);
    }

    .filter-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 1rem;
    }

    .filter-group {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }

    .filter-group label {
      font-size: 0.75rem;
      font-weight: 600;
      text-transform: uppercase;
      color: var(--text-secondary);
      letter-spacing: 0.5px;
    }

    .filter-group select,
    .filter-group input {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 0.75rem 1rem;
      color: var(--text-primary);
      font-size: 0.875rem;
      transition: border-color 0.2s, box-shadow 0.2s;
    }

    .filter-group select:focus,
    .filter-group input:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(255, 107, 157, 0.15);
    }

    /* ë©”ì¸ ì½˜í…ì¸  */
    .main-content {
      display: grid;
      grid-template-columns: 1fr;
      gap: 2rem;
    }

    .main-content.with-detail {
      grid-template-columns: 1fr 400px;
    }

    /* ì¹´ë“œ ê·¸ë¦¬ë“œ */
    .cards-container {
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      overflow: hidden;
    }

    .cards-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1rem 1.5rem;
      border-bottom: 1px solid var(--border);
    }

    .result-count {
      color: var(--text-secondary);
      font-size: 0.875rem;
    }

    .sort-controls {
      display: flex;
      gap: 0.5rem;
      align-items: center;
    }

    .sort-controls select {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 0.5rem 0.75rem;
      color: var(--text-primary);
      font-size: 0.875rem;
    }

    .cards-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 1rem;
      padding: 1.5rem;
      max-height: calc(100vh - 400px);
      overflow-y: auto;
    }

    /* ìš”ì†Œ ì¹´ë“œ */
    .element-card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 1.25rem;
      cursor: pointer;
      transition: all 0.2s;
      position: relative;
    }

    .element-card:hover {
      border-color: var(--accent);
      box-shadow: 0 4px 16px var(--shadow);
      transform: translateY(-2px);
    }

    .element-card.active {
      border-color: var(--accent);
      box-shadow: 0 0 0 2px var(--accent);
    }

    .element-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 3px;
      border-radius: var(--radius) var(--radius) 0 0;
    }

    .element-card.type-character::before {
      background: var(--character);
    }

    .element-card.type-object::before {
      background: var(--object);
    }

    .element-card.type-phenomenon::before {
      background: var(--phenomenon);
    }

    .element-card.type-hook::before {
      background: var(--hook);
    }

    .element-card.type-loop::before {
      background: var(--loop);
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 0.75rem;
    }

    .card-title {
      font-size: 1.125rem;
      font-weight: 600;
    }

    .card-type {
      font-size: 0.75rem;
      padding: 0.25rem 0.5rem;
      border-radius: 4px;
      font-weight: 500;
    }

    .card-type.type-character {
      background: rgba(255, 107, 157, 0.2);
      color: var(--character);
    }

    .card-type.type-object {
      background: rgba(0, 217, 255, 0.2);
      color: var(--object);
    }

    .card-type.type-phenomenon {
      background: rgba(168, 85, 247, 0.2);
      color: var(--phenomenon);
    }

    .card-type.type-hook {
      background: rgba(255, 171, 0, 0.2);
      color: var(--hook);
    }

    .card-type.type-loop {
      background: rgba(0, 230, 118, 0.2);
      color: var(--loop);
    }

    .card-meta {
      display: flex;
      gap: 1rem;
      color: var(--text-secondary);
      font-size: 0.875rem;
      margin-bottom: 0.75rem;
    }

    .card-tags {
      display: flex;
      flex-wrap: wrap;
      gap: 0.25rem;
    }

    .tag {
      background: var(--glass);
      border: 1px solid var(--border);
      padding: 0.125rem 0.5rem;
      border-radius: 4px;
      font-size: 0.75rem;
      color: var(--text-secondary);
    }

    /* ìƒì„¸ íŒ¨ë„ */
    .detail-panel {
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      overflow: hidden;
      position: sticky;
      top: 2rem;
      max-height: calc(100vh - 4rem);
      display: flex;
      flex-direction: column;
    }

    .detail-header {
      padding: 1.5rem;
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .detail-title {
      font-size: 1.25rem;
      font-weight: 600;
    }

    .detail-close {
      background: none;
      border: none;
      color: var(--text-secondary);
      font-size: 1.5rem;
      cursor: pointer;
      padding: 0.25rem;
      line-height: 1;
    }

    .detail-close:hover {
      color: var(--accent);
    }

    .detail-content {
      padding: 1.5rem;
      overflow-y: auto;
      flex: 1;
    }

    .detail-section {
      margin-bottom: 1.5rem;
    }

    .detail-section:last-child {
      margin-bottom: 0;
    }

    .detail-section h3 {
      font-size: 0.875rem;
      font-weight: 600;
      text-transform: uppercase;
      color: var(--text-secondary);
      margin-bottom: 0.5rem;
      letter-spacing: 0.5px;
    }

    .detail-raw {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 1rem;
      font-family: 'Monaco', 'Consolas', monospace;
      font-size: 0.875rem;
      white-space: pre-wrap;
      max-height: 400px;
      overflow-y: auto;
    }

    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 0.5rem;
    }

    .section-header h3 {
      margin-bottom: 0;
    }

    .copy-btn {
      background: var(--glass);
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 0.375rem 0.75rem;
      color: var(--text-secondary);
      font-size: 0.75rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 0.25rem;
      transition: all 0.2s;
    }

    .copy-btn:hover {
      background: var(--accent);
      border-color: var(--accent);
      color: var(--bg-primary);
    }

    .copy-btn.copied {
      background: var(--success);
      border-color: var(--success);
      color: var(--bg-primary);
    }

    /* ë¡œë”© / ì—ëŸ¬ / ë¹ˆ ìƒíƒœ */
    .loading,
    .error,
    .empty {
      text-align: center;
      padding: 4rem 2rem;
      color: var(--text-secondary);
    }

    .loading::before {
      content: '';
      display: block;
      width: 40px;
      height: 40px;
      border: 3px solid var(--border);
      border-top-color: var(--accent);
      border-radius: 50%;
      margin: 0 auto 1rem;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    .error {
      color: var(--warning);
    }

    /* ë°˜ì‘í˜• */
    @media (max-width: 1024px) {
      .main-content.with-detail {
        grid-template-columns: 1fr;
      }

      .detail-panel {
        position: fixed;
        top: 0;
        right: 0;
        bottom: 0;
        width: 100%;
        max-width: 450px;
        max-height: 100vh;
        z-index: 100;
        border-radius: 0;
        box-shadow: -4px 0 24px var(--shadow);
      }
    }

    @media (max-width: 768px) {
      .container {
        padding: 1rem;
      }

      header {
        flex-direction: column;
        gap: 1rem;
        text-align: center;
      }

      .cards-grid {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>

<body>
  <div class="container">
    <header>
      <h1>ğŸ“– Webnovel Viewer</h1>
      <div class="header-actions">
        <button class="theme-toggle" id="themeToggle" title="ë‹¤í¬ ëª¨ë“œ" aria-label="ë‹¤í¬ ëª¨ë“œ" aria-pressed="true">ğŸŒ™</button>
      </div>
    </header>

    <div class="stats" id="stats">
      <div class="stat-card">
        <div class="stat-value" id="totalElements">-</div>
        <div class="stat-label">ì „ì²´ ìš”ì†Œ</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="characterCount">-</div>
        <div class="stat-label">ìºë¦­í„°</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="objectCount">-</div>
        <div class="stat-label">ì‚¬ë¬¼</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="phenomenonCount">-</div>
        <div class="stat-label">í˜„ìƒ</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="hookCount">-</div>
        <div class="stat-label">ë³µì„ /ë–¡ë°¥</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="loopCount">-</div>
        <div class="stat-label">ë¯¸í•´ê²° ê³¼ì œ</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="episodeCount">-</div>
        <div class="stat-label">ì—í”¼ì†Œë“œ</div>
      </div>
    </div>

    <div class="filters">
      <div class="filters-header">
        <div class="filters-title">
          ğŸ” í•„í„°
          <span class="filter-count" id="filterCount">0</span>
        </div>
        <button type="button" class="clear-filters" id="clearFilters">í•„í„° ì´ˆê¸°í™”</button>
      </div>
      <div class="filter-grid">
        <div class="filter-group">
          <label for="searchInput">ê²€ìƒ‰</label>
          <input type="text" id="searchInput" placeholder="ì´ë¦„, íƒœê·¸, ë‚´ìš©...">
        </div>
        <div class="filter-group">
          <label for="typeFilter">ìœ í˜•</label>
          <select id="typeFilter">
            <option value="">ì „ì²´</option>
          </select>
        </div>
        <div class="filter-group">
          <label for="roleFilter">ì—­í• /ìœ í˜•</label>
          <select id="roleFilter">
            <option value="">ì „ì²´</option>
          </select>
        </div>
        <div class="filter-group">
          <label for="tagFilter">íƒœê·¸</label>
          <select id="tagFilter">
            <option value="">ì „ì²´</option>
          </select>
        </div>
        <div class="filter-group">
          <label for="firstAppearFilter">í™”(ë“±ì¥/ì‹¬ê¸°)</label>
          <select id="firstAppearFilter">
            <option value="">ì „ì²´</option>
          </select>
        </div>
      </div>
    </div>

    <div class="main-content" id="mainContent">
      <div class="cards-container">
        <div class="cards-header">
          <div class="result-count" id="resultCount" role="status">ë¡œë”© ì¤‘...</div>
          <div class="sort-controls">
            <select id="sortSelect" aria-label="ì •ë ¬ ê¸°ì¤€">
              <option value="first_appear">ë“±ì¥ìˆœ</option>
              <option value="display_name">ì´ë¦„ìˆœ</option>
              <option value="type">ìœ í˜•ìˆœ</option>
            </select>
            <select id="orderSelect" aria-label="ì •ë ¬ ìˆœì„œ">
              <option value="asc">ì˜¤ë¦„ì°¨ìˆœ</option>
              <option value="desc">ë‚´ë¦¼ì°¨ìˆœ</option>
            </select>
          </div>
        </div>
        <div class="cards-grid" id="cardsGrid" aria-live="polite">
          <div class="loading">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
        </div>
      </div>

      <div class="detail-panel" id="detailPanel" style="display: none;">
        <div class="detail-header">
          <div class="detail-title" id="detailTitle">ìƒì„¸ ì •ë³´</div>
          <button class="detail-close" id="detailClose" aria-label="ë‹«ê¸°">&times;</button>
        </div>
        <div class="detail-content" id="detailContent"></div>
      </div>
    </div>
  </div>

  <script>
    // ìƒíƒœ
    let elements = [];
    let options = { types: [], roles: [], tags: [], firstAppears: [] };
    let selectedSlug = null;

    // DOM ìš”ì†Œ
    const el = {
      themeToggle: document.getElementById('themeToggle'),
      searchInput: document.getElementById('searchInput'),
      typeFilter: document.getElementById('typeFilter'),
      roleFilter: document.getElementById('roleFilter'),
      tagFilter: document.getElementById('tagFilter'),
      firstAppearFilter: document.getElementById('firstAppearFilter'),
      sortSelect: document.getElementById('sortSelect'),
      orderSelect: document.getElementById('orderSelect'),
      clearFilters: document.getElementById('clearFilters'),
      filterCount: document.getElementById('filterCount'),
      resultCount: document.getElementById('resultCount'),
      cardsGrid: document.getElementById('cardsGrid'),
      mainContent: document.getElementById('mainContent'),
      detailPanel: document.getElementById('detailPanel'),
      detailTitle: document.getElementById('detailTitle'),
      detailContent: document.getElementById('detailContent'),
      detailClose: document.getElementById('detailClose'),
      totalElements: document.getElementById('totalElements'),
      characterCount: document.getElementById('characterCount'),
      objectCount: document.getElementById('objectCount'),
      phenomenonCount: document.getElementById('phenomenonCount'),
      hookCount: document.getElementById('hookCount'),
      loopCount: document.getElementById('loopCount'),
      episodeCount: document.getElementById('episodeCount'),
    };

    // API í˜¸ì¶œ
    async function fetchApi(endpoint) {
      const response = await fetch(endpoint);
      if (!response.ok) throw new Error(`API Error: ${response.status}`);
      return response.json();
    }

    // í…Œë§ˆ í† ê¸€
    function initTheme() {
      const saved = localStorage.getItem('wn-theme') || 'dark';
      document.documentElement.setAttribute('data-theme', saved);
      updateThemeButton(saved);
    }

    function updateThemeButton(theme) {
      const isDark = theme === 'dark';
      el.themeToggle.textContent = isDark ? 'ğŸŒ™' : 'â˜€ï¸';
      el.themeToggle.setAttribute('aria-pressed', String(isDark));
      el.themeToggle.setAttribute('aria-label', isDark ? 'ë‹¤í¬ ëª¨ë“œ' : 'ë¼ì´íŠ¸ ëª¨ë“œ');
      el.themeToggle.setAttribute('title', isDark ? 'ë‹¤í¬ ëª¨ë“œ' : 'ë¼ì´íŠ¸ ëª¨ë“œ');
    }

    el.themeToggle.addEventListener('click', () => {
      const current = document.documentElement.getAttribute('data-theme');
      const next = current === 'dark' ? 'light' : 'dark';
      document.documentElement.setAttribute('data-theme', next);
      localStorage.setItem('wn-theme', next);
      updateThemeButton(next);
    });

    // í•„í„° ì˜µì…˜ ë¡œë“œ
    async function loadOptions() {
      try {
        options = await fetchApi('/api/options');

        // ìœ í˜•
        options.types.forEach(t => {
          const opt = document.createElement('option');
          opt.value = t.name;
          opt.textContent = t.display_name;
          el.typeFilter.appendChild(opt);
        });

        // ì—­í• 
        options.roles.forEach(r => {
          const opt = document.createElement('option');
          opt.value = r;
          opt.textContent = r;
          el.roleFilter.appendChild(opt);
        });

        // íƒœê·¸
        options.tags.forEach(t => {
          const opt = document.createElement('option');
          opt.value = t;
          opt.textContent = `#${t}`;
          el.tagFilter.appendChild(opt);
        });

        // ë“±ì¥í™”
        options.firstAppears.forEach(f => {
          const opt = document.createElement('option');
          opt.value = f;
          opt.textContent = `${f}í™”`;
          el.firstAppearFilter.appendChild(opt);
        });
      } catch (error) {
        console.error('ì˜µì…˜ ë¡œë“œ ì‹¤íŒ¨:', error);
      }
    }

    // í†µê³„ ë¡œë“œ
    async function loadStats() {
      try {
        const stats = await fetchApi('/api/stats');
        el.totalElements.textContent = stats.totalElements;
        el.episodeCount.textContent = stats.totalEpisodes;

        // ìœ í˜•ë³„ ì¹´ìš´íŠ¸
        const byType = {};
        stats.byType.forEach(t => byType[t.type] = t.count);
        el.characterCount.textContent = byType['ìºë¦­í„°'] || 0;
        el.objectCount.textContent = byType['ì‚¬ë¬¼'] || 0;
        el.phenomenonCount.textContent = byType['í˜„ìƒ'] || 0;
        el.hookCount.textContent = byType['ë³µì„ /ë–¡ë°¥'] || 0;
        el.loopCount.textContent = byType['ë¯¸í•´ê²° ê³¼ì œ'] || 0;
      } catch (error) {
        console.error('í†µê³„ ë¡œë“œ ì‹¤íŒ¨:', error);
      }
    }

    // ìš”ì†Œ ëª©ë¡ ë¡œë“œ
    async function loadElements() {
      const params = new URLSearchParams();

      if (el.searchInput.value) params.set('q', el.searchInput.value);
      if (el.typeFilter.value) params.set('type', el.typeFilter.value);
      if (el.roleFilter.value) params.set('role', el.roleFilter.value);
      if (el.tagFilter.value) params.set('tag', el.tagFilter.value);
      if (el.firstAppearFilter.value) params.set('first_appear', el.firstAppearFilter.value);
      params.set('sort', el.sortSelect.value);
      params.set('order', el.orderSelect.value);

      try {
        el.cardsGrid.innerHTML = '<div class="loading">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>';
        elements = await fetchApi(`/api/elements?${params}`);
        renderCards();
        updateFilterCount();
      } catch (error) {
        const errDiv = document.createElement('div');
        errDiv.className = 'error';
        errDiv.textContent = `âŒ ë¡œë“œ ì‹¤íŒ¨: ${error.message}`;
        el.cardsGrid.innerHTML = '';
        el.cardsGrid.appendChild(errDiv);
      }
    }

    // ì¹´ë“œ ë Œë”ë§
    function renderCards() {
      if (elements.length === 0) {
        el.cardsGrid.innerHTML = '<div class="empty">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
        el.resultCount.textContent = '0ê°œ ê²°ê³¼';
        return;
      }

      el.resultCount.textContent = `${elements.length}ê°œ ê²°ê³¼`;

      el.cardsGrid.innerHTML = elements.map(e => `
        <div class="element-card type-${e.type} ${selectedSlug === e.slug ? 'active' : ''}" 
             data-slug="${escapeHtml(e.slug)}"
             tabindex="0"
             role="button"
             aria-pressed="${selectedSlug === e.slug}">
          <div class="card-header">
            <div class="card-title">${escapeHtml(e.display_name)}</div>
            <span class="card-type type-${e.type}">${escapeHtml(e.type_display)}</span>
          </div>
          <div class="card-meta">
            ${e.role ? `<span>ğŸ“Œ ${escapeHtml(e.role)}</span>` : ''}
            ${e.first_appear ? `<span>ğŸ“– ${e.first_appear}í™”</span>` : ''}
          </div>
          ${e.tags ? `
            <div class="card-tags">
              ${e.tags.split(',').map(t => `<span class="tag">#${escapeHtml(t.trim())}</span>`).join('')}
            </div>
          ` : ''}
        </div>
      `).join('');

      // ì¹´ë“œ í´ë¦­ ì´ë²¤íŠ¸
      el.cardsGrid.querySelectorAll('.element-card').forEach(card => {
        card.addEventListener('click', () => showDetail(card.dataset.slug));
        card.addEventListener('keydown', (e) => {
          if (e.key === 'Enter' || e.key === ' ') {
            e.preventDefault();
            showDetail(card.dataset.slug);
          }
        });
      });
    }

    // ì¹´ë“œ active ìƒíƒœë§Œ ì—…ë°ì´íŠ¸ (ìŠ¤í¬ë¡¤ ìœ„ì¹˜ ë³´ì¡´)
    function updateActiveCard(newSlug) {
      el.cardsGrid.querySelectorAll('.element-card').forEach(card => {
        const isActive = card.dataset.slug === newSlug;
        card.classList.toggle('active', isActive);
        card.setAttribute('aria-pressed', String(isActive));
      });
    }

    // ìƒì„¸ ë³´ê¸°
    async function showDetail(slug) {
      if (selectedSlug === slug) {
        closeDetail();
        return;
      }

      selectedSlug = slug;
      el.mainContent.classList.add('with-detail');
      el.detailPanel.style.display = 'flex';

      // ë”œ ë§í‚¹: URL ì—…ë°ì´íŠ¸
      const url = new URL(window.location.href);
      url.searchParams.set('slug', slug);
      history.pushState({ slug }, '', url);

      try {
        const detail = await fetchApi(`/api/elements/${encodeURIComponent(slug)}`);
        el.detailTitle.textContent = detail.display_name;

        el.detailContent.innerHTML = `
          <div class="detail-section">
            <h3>ê¸°ë³¸ ì •ë³´</h3>
            <p><strong>ìœ í˜•:</strong> ${escapeHtml(detail.type_display)}</p>
            ${detail.role ? `<p><strong>ì—­í• /ìœ í˜•:</strong> ${escapeHtml(detail.role)}</p>` : ''}
            ${detail.first_appear ? `<p><strong>í™”(ë“±ì¥/ì‹¬ê¸°):</strong> ${detail.first_appear}í™”</p>` : ''}
            ${detail.tags ? `<p><strong>íƒœê·¸:</strong> ${detail.tags.split(',').map(t => `#${escapeHtml(t.trim())}`).join(' ')}</p>` : ''}
          </div>
          <div class="detail-section">
            <div class="section-header">
              <h3>ì›ë³¸ ë‚´ìš©</h3>
              <button class="copy-btn" id="copyRawBtn" type="button" aria-label="ì›ë³¸ ë‚´ìš© ë³µì‚¬">ğŸ“‹ ë³µì‚¬</button>
            </div>
            <pre class="detail-raw" id="rawContentPre">${escapeHtml(detail.raw_content)}</pre>
          </div>
        `;

        // ì¹´ë“œ active ìƒíƒœ ì—…ë°ì´íŠ¸ (ì „ì²´ ë Œë”ë§ ì—†ì´ ìŠ¤í¬ë¡¤ ë³´ì¡´)
        updateActiveCard(slug);
        // ë³µì‚¬ ë²„íŠ¼ ì„¤ì •
        setupCopyButton(detail.raw_content);

        // ì ‘ê·¼ì„±: íŒ¨ë„ ì—´ë¦° í›„ ë‹«ê¸° ë²„íŠ¼ìœ¼ë¡œ í¬ì»¤ìŠ¤ ì´ë™
        setTimeout(() => el.detailClose.focus(), 0);

        // ëª¨ë°”ì¼ UX: íŒ¨ë„ ì—´ë¦´ ë•Œ body ìŠ¤í¬ë¡¤ ë§‰ê¸°
        if (window.innerWidth <= 1024) {
          document.body.style.overflow = 'hidden';
        }
      } catch (error) {
        const errDiv = document.createElement('div');
        errDiv.className = 'error';
        errDiv.textContent = `âŒ ë¡œë“œ ì‹¤íŒ¨: ${error.message}`;
        el.detailContent.innerHTML = '';
        el.detailContent.appendChild(errDiv);
      }
    }

    // ìƒì„¸ ë‹«ê¸°
    function closeDetail() {
      const prevSlug = selectedSlug;
      selectedSlug = null;
      el.mainContent.classList.remove('with-detail');
      el.detailPanel.style.display = 'none';
      // ëª¨ë°”ì¼ UX: body ìŠ¤í¬ë¡¤ ë³µì›
      document.body.style.overflow = '';
      // ì¹´ë“œ active ìƒíƒœ ì—…ë°ì´íŠ¸ (ì „ì²´ ë Œë”ë§ ì—†ì´ ìŠ¤í¬ë¡¤ ë³´ì¡´)
      updateActiveCard(null);
      // ë”œ ë§í‚¹: URLì—ì„œ slug ì œê±°
      const url = new URL(window.location.href);
      url.searchParams.delete('slug');
      history.pushState({}, '', url);
      // ì ‘ê·¼ì„±: ì´ì „ ì„ íƒ ì¹´ë“œë¡œ í¬ì»¤ìŠ¤ ë³µì›
      if (prevSlug) {
        const card = el.cardsGrid.querySelector(`[data-slug="${CSS.escape(prevSlug)}"]`);
        if (card) card.focus();
      }
    }

    el.detailClose.addEventListener('click', closeDetail);

    // ì›ë³¸ ë‚´ìš© ë³µì‚¬
    function setupCopyButton(rawContent) {
      const btn = document.getElementById('copyRawBtn');
      if (!btn) return;
      btn.addEventListener('click', async () => {
        try {
          await navigator.clipboard.writeText(rawContent);
          btn.classList.add('copied');
          btn.innerHTML = 'âœ… ë³µì‚¬ë¨';
          setTimeout(() => {
            btn.classList.remove('copied');
            btn.innerHTML = 'ğŸ“‹ ë³µì‚¬';
          }, 2000);
        } catch (err) {
          console.error('ë³µì‚¬ ì‹¤íŒ¨:', err);
          btn.innerHTML = 'âŒ ì‹¤íŒ¨';
          setTimeout(() => btn.innerHTML = 'ğŸ“‹ ë³µì‚¬', 2000);
        }
      });
    }

    // ìœ í‹¸ë¦¬í‹°
    function escapeHtml(str) {
      if (str == null) return '';
      return String(str).replace(/[&<>"']/g, char => ({
        '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;'
      })[char]);
    }

    function updateFilterCount() {
      let count = 0;
      if (el.searchInput.value) count++;
      if (el.typeFilter.value) count++;
      if (el.roleFilter.value) count++;
      if (el.tagFilter.value) count++;
      if (el.firstAppearFilter.value) count++;
      el.filterCount.textContent = count;
    }

    // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
    let debounceTimer;
    function debounce(fn, delay = 300) {
      clearTimeout(debounceTimer);
      debounceTimer = setTimeout(fn, delay);
    }

    el.searchInput.addEventListener('input', () => debounce(loadElements));
    el.typeFilter.addEventListener('change', loadElements);
    el.roleFilter.addEventListener('change', loadElements);
    el.tagFilter.addEventListener('change', loadElements);
    el.firstAppearFilter.addEventListener('change', loadElements);
    el.sortSelect.addEventListener('change', loadElements);
    el.orderSelect.addEventListener('change', loadElements);

    el.clearFilters.addEventListener('click', () => {
      el.searchInput.value = '';
      el.typeFilter.value = '';
      el.roleFilter.value = '';
      el.tagFilter.value = '';
      el.firstAppearFilter.value = '';
      loadElements();
    });

    // ESCë¡œ ìƒì„¸ ë‹«ê¸°
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && selectedSlug) closeDetail();
    });

    // ì´ˆê¸°í™”
    async function init() {
      initTheme();
      await loadOptions();
      await loadStats();
      await loadElements();

      // ë”œ ë§í‚¹: URLì—ì„œ slug í™•ì¸ í›„ ìƒì„¸ íŒ¨ë„ ì—´ê¸°
      const urlParams = new URLSearchParams(window.location.search);
      const slugFromUrl = urlParams.get('slug');
      if (slugFromUrl) {
        showDetail(slugFromUrl);
      }
    }

    // ë¸Œë¼ìš°ì € ë’¤ë¡œê°€ê¸°/ì•ìœ¼ë¡œê°€ê¸° ì§€ì›
    window.addEventListener('popstate', (e) => {
      if (e.state?.slug) {
        showDetail(e.state.slug);
      } else if (selectedSlug) {
        closeDetail();
      }
    });

    init();
  </script>
</body>

</html>
