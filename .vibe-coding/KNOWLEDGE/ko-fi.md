# Ko-fi 주요 변경 사항 요약 및 대응 전략 (2024-11 ~ 2025-12)

Ko-fi는 공식 API에 버전을 부여하지 않으며, 핵심 npm 패키지(예: `@ko-fi/next`, `@ko-fi/express`)는 2024년 11월 13일부터 2025년 12월 3일 사이에 **새 릴리스가 전혀 없었습니다.** 따라서 요청하신 기간에 해당하는 **API `deprecated`, 신규 기능 추가, 또는 사용법 변경은 공개적으로 확인되지 않습니다.**

핵심은 **기간 내 변경 없음**과 **현재 웹훅 스펙을 방어적으로 구현**하는 것입니다.

---

## 1. 요청 기간 내 업데이트 현황 및 결론

| 구분 | 대상 | 변경 결과 | 비고 |
| :--- | :--- | :--- | :--- |
| **API/SDK** | Ko-fi Webhook API, `@ko-fi/*` 패키지 | **변경 없음** | 2023년 이후 공식 릴리스 부재. |
| **결론** | 기간 내 API 변경점 | **없음** | 기존 코드는 그대로 동작합니다. |

---

## 2. 현재 웹훅 스펙 및 코딩 필수 요소

버전 변경이 없는 대신, 현재 Ko-fi 웹훅을 통합할 때 반드시 지켜야 할 **구조적 제약과 보안 규칙**입니다.

### 2-1. 요청 처리 및 파싱 (구조적 제약)

Ko-fi 웹훅은 일반적인 `application/json` 형태가 아닌, **`application/x-www-form-urlencoded`** 형태로 전송됩니다.

* **Action:** 웹훅 엔드포인트는 `POST` 요청을 받아, `req.body`에서 **`data`** 필드를 추출한 뒤 **JSON 파싱**을 수행해야 합니다.

| 항목 | 스펙 | 필수 서버 로직 |
| :--- | :--- | :--- |
| **Content-Type** | `application/x-www-form-urlencoded` | **Form-urlencoded 파서** 사용 |
| **Payload 위치** | `data=<JSON 문자열>` | `JSON.parse(req.body.data)` 필요 |
| **응답 코드** | `HTTP 200 OK` | 재시도 방지를 위해 **성공 시 항상 200** 응답 |

### 2-2. 보안 및 중복 처리 (Idempotency)

| 필드 | 용도 | 실무적 의무 사항 |
| :--- | :--- | :--- |
| **`verification_token`** | Ko-fi에서 요청이 왔는지 확인하는 평문 토큰. | **환경 변수**에 토큰 저장 후, 요청 바디의 토큰과 **일치 여부 검증**해야 함 (보안 필수). |
| **`message_id`** | 웹훅 호출의 고유 ID (UUID). | **DB에 저장**하여 중복 처리 방지 (Idempotency 필수). |
| **`is_public`** | 후원자가 메시지 공개를 허용했는지 여부. | `is_public`이 `false`면 어떤 외부 채널(Discord, UI)에도 **메시지/이름 노출 금지** 로직 구현. |

### 2-3. 이벤트 타입별 분기 (Type Handling)

웹훅 페이로드의 **`type`** 필드를 기준으로 비즈니스 로직을 분기해야 합니다.

| `type` 값 | 설명 | 비즈니스 로직 예시 |
| :--- | :--- | :--- |
| `Donation` | 단발성 후원 | 감사 알림 전송, 후원 합산. |
| `Subscription` | 멤버십 가입/갱신 | 멤버십 역할 부여, 만료일 연장. |
| `Shop Order` | 디지털/실물 상품 구매 | 상품 발송, 다운로드 링크 생성. |

---

## 3. 장기적인 연동 설계 체크리스트

버전 로그가 부재한 서비스와 연동할 때는 **방어적 설계**가 중요합니다.

1. **방어적 스키마 정의:** TypeScript/Go 등의 언어로 현재 웹훅 필드 구조를 정의하되, 새로운 필드가 추가되어도 실패하지 않도록 **Strict 모드를 피하고** 알 수 없는 필드는 무시하도록 설계하십시오.
2. **금액 처리:** `amount`와 `currency` 필드를 항상 함께 저장하고, 서버에서 `amount` 문자열을 정확한 숫자 타입(Decimal/BigInt)으로 재파싱하는 로직을 구현하십시오.
3. **SDK 의존성 제거:** 공식 JS SDK/핸들러 패키지(예: `@ko-fi/next`)가 동결 상태이므로, 해당 패키지에 의존하기보다 **자체적인 웹훅 핸들러**를 구축하고 위의 보안 검증 로직을 직접 포함하는 것이 안전합니다.

**결론:** Ko-fi는 **안정적인 스펙**을 유지하고 있으므로, 현재의 웹훅 구조를 기반으로 **Idempotency**와 **Token 검증** 로직을 견고하게 구축하는 것이 최선의 연동 전략입니다.
