# 100+ 사이트를 위한 중앙 인증 백엔드 설계

## 핵심 통찰

이메일 발송은 그냥 숨 쉬기이고, 진짜 힘은 "내 네트워크 전체를 관통하는 것"을 쥐는 데서 나온다.

회원이 많아질수록 힘은 세 가지를 어느 정도까지 직접 쥐고 있느냐로 결정된다:

1. 사람의 "신분증" (ID 그래프)
2. 사람의 "연결 그래프" (행동 로그)
3. 사람의 "지갑과 평판" (구독/결제)

---

## 1. 기능 축별 평가

남이 대신해 주기 어렵고, 한 번 만들면 모든 사이트에서 써먹히는 것이 진짜 힘이다.

| 기능 축 | 예시 기능 | 영향력 | 난이도 | 미래 확장 | 종합 |
|---------|----------|:------:|:------:|:--------:|:----:|
| 통합 사용자 프로필·ID 그래프 | 모든 사이트 관통 user_id, 아바타, 소셜 계정 링크 | 9 | 6 | 9 | 9 |
| 통합 알림·선호 설정 허브 | 이메일·웹푸시·인앱 채널 통합, 언어·시간대 설정 | 8 | 6 | 9 | 8 |
| 동의·프라이버시·마이데이터 센터 | 통합 "마이데이터", 탈퇴, 데이터 내보내기 | 7 | 7 | 9 | 8 |
| 행동 로그·이벤트 파이프라인 | 로그인, 구독, 클릭 이벤트를 중앙에 모으는 레이어 | 9 | 7 | 9 | 8 |
| 구독·결제 메타 계층 | Stripe·Paddle 감싸는 내 구독 서버, 번들 요금제 | 9 | 8 | 9 | 8 |
| 신뢰·리스크 엔진 | 스팸·어뷰즈 탐지, IP·디바이스 지문 분석 | 7 | 8 | 8 | 7 |
| 평판·레벨·배지 시스템 | 기여도 기반 레벨, 네트워크 전체 평판 점수 | 8 | 6 | 8 | 7 |
| 크로스 사이트 추천·프로모션 | Site A 가입자에게 Site B 추천 | 8 | 7 | 8 | 7 |
| 운영·어드민 콘솔 | 100개 사이트 유저·구독·로그를 한 화면에서 관리 | 8 | 6 | 8 | 8 |
| 보안·컴플라이언스·감사 레이어 | MFA, RBAC, 감사 로그, API 키 발급·회수, 세션 관리 | 9 | 7 | 9 | 9 |

> **점수 기준**
>
> - 영향력 = 네트워크 전체에 미치는 레버리지 × 데이터 독점도
> - 난이도 = 1인 개발자가 3개월 안에 혼자 만들 수 있느냐
> - 미래 확장 = 3년 뒤에도 후회 안 할 아키텍처인가

---

## 2. 핵심 기능 상세

### 2.1 통합 사용자 프로필·ID 그래프 (종합 9점)

이미 중앙 Auth와 멀티테넌트 DB를 생각하고 있으니, 이걸 한 단계만 더 밀면 된다.

할 수 있는 것들:

- 모든 사이트가 공유하는 글로벌 user_id
- 사이트별 닉네임은 다르지만, "이 사람은 같은 사람"이라는 그래프를 너만 알고 있음
- 소셜 로그인 여러 개를 하나의 계정에 통합
- 아바타, 언어, 시간대, 접근성 옵션 같은 "사람 설정"을 중앙에서 관리
- **SSO(Single Sign-On)**: 한 번 로그인하면 다른 사이트도 토큰만 발급받아 바로 진입. OIDC 기반 경량 SSO + Silent Auth 리다이렉트로 끊김 없는 경험 제공

이걸 네가 쥐고 있으면:

- 새 사이트를 만들 때 "회원 기능"이 아니라 "회원 연결"만 하면 된다
- 특정 유저의 문제(환불, 악성 행동)를 네트워크 전체에서 대응 가능
- VIP에게는 어디서든 우대 혜택을 줄 수 있다

이건 어떤 서비스가 망해도 남는 자산이다. 프로덕트는 닫더라도 "사람의 네트워크 맵"은 계속 쌓인다.

---

### 2.2 통합 알림 허브와 선호 설정

이메일은 단지 채널 하나일 뿐이다. 조금만 더 나아가면 "내 네트워크 전체의 알림 허브"가 된다.

구체적인 기능:

- 각 유저별 "알림 선호도"를 한 번만 저장 (이메일 허용, 마케팅 수신, 야간 푸시 차단, 선호 언어)
- 채널 추상화: `notify(userId, "password_reset", payload)` 같은 공통 함수
- 사이트별 템플릿은 다르지만 "이벤트 이름"은 공통 (`user_signup`, `password_reset`, `subscription_renewed`)

이걸 네가 만들면:

- Resend, SES를 교체해도 "알림 시스템"은 안 바뀐다
- 새 사이트를 만들 때 "알림 채널" 고민 없이 바로 붙일 수 있다
- 나중에 브라우저 알림, 모바일 푸시, SMS를 붙이고 싶어도 백엔드 인터페이스는 그대로

---

### 2.3 동의·프라이버시·마이데이터 센터

장기적으로 굉장히 중요한 힘이다.

"내 계정 센터" 하나에서:

- 모든 사이트의 계정 목록
- 각 사이트에서 저장하고 있는 핵심 데이터 요약
- "전체 탈퇴"와 "서비스별 탈퇴"를 모두 제공
- 데이터 다운로드, 정정 요청, 삭제 요청 (GDPR 대응)
- 광고·트래킹 동의 상태를 중앙에서 관리 (Site A에서 거부 → Site B에서도 자동 반영)

왜 직접 쥐면 좋냐면:

- 어느 특정 애널리틱스 서비스에 영혼까지 맡기지 않아도 된다
- 법이 바뀌어도 "내 기준으로" 대응 가능
- 유저 관점: "이 생태계는 나를 한 사람으로 대우한다"는 신뢰감

---

### 2.4 행동 로그·이벤트 파이프라인

모든 사이트의 "중요 이벤트"를 중앙으로 모은다:

- 회원가입, 로그인, 비밀번호 변경
- 구독 시작·해지
- 특정 핵심 기능 사용 여부
- 추천·공유 같은 행동

구현 방식:

- Workers 한 군데에 `/track` 엔드포인트
- 각 사이트에서 비동기로 `fetch`
- D1 또는 R2에 이벤트 스트림으로 저장

이걸 쥐고 있으면:

- "어떤 사이트가 진짜 살아 있고, 어떤 사이트는 식물 상태인지" 유저 레벨까지 파악
- 맞춤 추천, 리텐션 분석, 가격 실험을 이 레이어 위에 얹을 수 있다
- 남에게 줄 수 있는 건 "집계된 것", 너만 볼 수 있는 원천 이벤트 스트림은 네가 쥔 힘

---

### 2.5 구독·결제 메타 계층

결제 자체는 Stripe, Paddle, Toss 등 어디에 얹어도 좋다.
대신 "누가 어떤 상품을 쓰고 있는지"를 표현하는 모델은 네가 가져간다.

예시:

- `subscriptions`를 중앙 Auth와 붙임 (product_id, site_id, user_id, 상태, 갱신일)
- Site A 구독자가 Site B의 일부 유료 기능을 무료로 쓰게 하는 번들
- 네트워크 전체 "프리미엄 회원" 등급
- 여러 사이트를 묶은 패스 상품

이걸 직접 정의해 두면:

- 결제 벤더를 갈아타도 "누가 무엇을 사용하는가"는 그대로 유지
- 새 사이트를 만들 때, 기존 유저에게 바로 혜택을 줄 수 있다
- 파트너 사이트와 수익을 나눌 때도 같은 모델을 재활용

> [!WARNING]
> Stripe Customer ID를 중앙 DB에만 의존하지 마라. Stripe webhook은 2~3분 지연이 기본이고 가끔 누락된다.
> **내 DB가 진실의 원천**이 되게 설계하라. Stripe는 결제 실행기일 뿐, `subscriptions` 테이블이 상태의 주인이다.

---

### 2.6 신뢰·평판·성장 시스템

네트워크 전체 평판 점수:

- 신고, 차단, 악성 패턴을 합산
- 반대로 기여, 구매 이력으로 플러스

레벨·배지:

- 여러 사이트에서 활동해도 같은 계정에 레벨이 붙는다
- "이 사람은 내 생태계에서 오래 놀던 사람"이라는 신호

추천 시스템:

- Site A에서 어떤 콘텐츠를 즐기는 사람에게 Site B, Site C의 관련 콘텐츠를 추천

격벽 시스템 (SPOF 방지):

- 특정 사이트가 공격받으면 해당 사이트의 API 키만 즉시 무효화
- 나머지 99개 사이트는 영향 없이 계속 운영
- 중앙 인증 서버가 뚫려도 피해 범위를 최소화하는 격리 설계 필수

이 축을 잡으면 "사이트 여러 개를 운영하는 사람"을 넘어서 작은 생태계를 운영하는 쪽으로 옮겨간다.
생태계에는 입구가 많아질수록, 중심의 힘이 커진다.

---

## 3. 현실적인 로드맵

지금 당장 다 만들 필요는 없다. 대략 이런 순서를 추천한다.

### 0단계 – 시작 전 필수 결정 (Week 0)

- `user_id`를 **UUID v7**로 확정 (시간 순 정렬 + 절대 변경 불가)
- 모든 테이블에 `global_user_id` 칼럼 강제
- 사이트 식별자(`site_id` 또는 `domain`) 스키마 확정

> [!CAUTION]
> 이 단계를 건너뛰면 2단계부터 마이그레이션 지옥이 시작된다.

---

### 1단계 – 이미 하고 있는 것 확실하게 다지기

- 중앙 Auth
- 멀티테넌트 스키마
- 이메일 알림의 인터페이스 추상화

### 2단계 – 최소한의 "나만의 힘" 만들기

- 통합 프로필
- 알림 선호 설정
- 간단한 이벤트 로그 저장
- 아주 심플한 어드민 콘솔

### 3단계 – 돈과 평판의 레이어

- 구독·결제 메타 계층
- 네트워크 전체 평판·레벨
- 사이트 간 추천 모듈

### 4단계 – 규범과 프라이버시

- 데이터 내보내기
- 통합 탈퇴
- 동의 로그 시스템

---

## 4. 오버엔지니어링 주의

| 기능 | 유혹도 | 실제 가치 | 이유 |
|------|:------:|:---------:|------|
| 사이트별 커스텀 테마 엔진 | ★★★★★ | ★ | 비즈니스 모델 아니라 취미 |
| 실시간 채팅 | ★★★★ | ★★ | 1인 24/7 지원 불가, Crisp 연동이 낫다 |
| 사용자 프로필 커스텀 필드 | ★★★ | ★ | users.meta JSONB 칼럼으로 충분 |
| 자체 분석 대시보드 | ★★★★ | ★ | Cloudflare Analytics + Plausible로 충분 |
| 자체 OAuth Provider | ★★★★★ | ★ | Auth0/Clerk 벗어나려다 GDPR·보안 패치 지옥 |
| 복잡한 시각화 어드민 | ★★★★★ | ★★ | 예쁜 차트보다 SQL 조회 + CSV 다운로드가 실무에선 더 빠르다 |
| 커스텀 SSO 프로토콜 | ★★★★ | ★ | OIDC·OAuth 표준을 쓰는 편이 훨쥌 안전하고, 유지보수도 쉬다 |

---

## 5. 3-Week Quick Start

| 주차 | 목표 | 효과 |
|:----:|------|------|
| Week 1 | 이벤트 수집 + 어드민 대시보드 | 전체 현황 파악 |
| Week 2 | 크로스 사이트 추천 엔진 | 트래픽 순환 시작 |
| Week 3 | 통합 알림 센터 | 이탈 지점 가시화 및 리텐션 실험 기반 마련 |

---

## 6. 중앙 집중의 힘과 리스크

이 모든 것을 한 곳에 모으는 순간, 힘과 함께 리스크도 같이 몰린다:

- 중앙 인증 백엔드가 멈추면 100개 사이트가 동시에 멈춘다
- 잘못된 정책이나 버그가 배포되면 전체 생태계에 즉시 전파된다

그래서 이 시스템은 "한 번 만들어두면 끝나는 인프라"가 아니라, 살아 있는 규범이자 운영 대상이다:

- 점진적 롤아웃과 피처 플래그
- 실험용 샌드박스
- 롤백 전략과 모니터링

이런 것들이 함께 설계에 들어가야, 100개 사이트가 하나의 네트워크로 묶이면서도 위험은 통제 가능한 수준에 머무른다.

---

## 7. 결론

여기까지 가면 벤더는 언제든 갈아탈 수 있는 파트너가 되고, 정말 바꾸기 힘든 것은 "네가 쌓은 사람들의 역사"가 된다.

이 시스템 구축하면:

- 신규 사이트 런칭 시 기존 유저 기반 활용
- 경쟁자가 도달할 수 없는 데이터 다양성
- 사용자 이탈율 감소 (여러 사이트에 걸쳐 있으므로)
- 수익화 채널 다양화 (교차 판매, 데이터 인사이트)

진정한 "나만의 힘":
코드는 복사할 수 있지만, 이 아키텍처를 운영하는 경험과 판단력은 복사할 수 없다.

데이터가 네트워크 전체를 더 스마트하게 만드는 연료로 사용될 때,
100개 사이트는 개별 사이트 100개가 아니라 하나의 거대한 플랫폼이 된다.

> 결국 핵심은 이것이다:
> **"한 명의 유저가 100개 사이트에서 노는 하나의 거대 플랫폼"**—그 중심에 네가 앉아 있으면 된다.
